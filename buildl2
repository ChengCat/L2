#!/usr/bin/env bash
mkdir -p bin

musl-gcc -fPIC -g -c -o bin/sexpr.o src/sexpr.c
objcopy --redefine-syms=assets/l2_sym_pairs bin/sexpr.o
musl-gcc -m64 -shared -o bin/sexpr.so bin/sexpr.o
rm bin/sexpr.o

musl-gcc -fPIC -g -c -o bin/l2compile.o src/compile.c
objcopy --redefine-syms=assets/l2_sym_pairs bin/l2compile.o
musl-gcc -m64 -shared -o bin/l2compile.so bin/l2compile.o
rm bin/l2compile.o

musl-gcc -g -c -o bin/l2evaluate.o src/evaluate.c
objcopy --redefine-syms=assets/l2_sym_pairs bin/l2evaluate.o
musl-gcc -m64 -g -o bin/l2evaluate bin/l2evaluate.o -ldl
rm bin/l2evaluate.o

musl-gcc -g -c -o bin/amd64.o assets/amd64.s
objcopy --redefine-syms=assets/arch_sym_pairs bin/amd64.o
musl-gcc -m64 -shared -o bin/amd64.so bin/amd64.o
rm bin/amd64.o

cp assets/libfn bin/libfn
